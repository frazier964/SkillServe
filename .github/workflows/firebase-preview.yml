name: Firebase Preview Deploy for PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy preview to Firebase Hosting channel
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          CHANNEL_ID=pr-${PR_NUMBER}
          echo "Deploying preview to channel: $CHANNEL_ID"
          npx firebase-tools@latest hosting:channel:deploy "$CHANNEL_ID" --expires 7d --only hosting --project skillserve-c4c53 --token "$FIREBASE_TOKEN" | tee deploy_output.txt
          # Extract first HTTPS URL from the deploy output (the preview URL)
          PREVIEW_URL=$(grep -oE 'https?://[^ ]+' deploy_output.txt | sed -n '1p' || true)
          echo "Preview URL=$PREVIEW_URL" >> $GITHUB_OUTPUT
          PR_HEAD_SHA=${{ github.event.pull_request.head.sha }}

          if [ -n "$PREVIEW_URL" ]; then
            echo "Setting commit status on $PR_HEAD_SHA"
            # Create a GitHub commit status so the preview appears in the Checks/Statuses for the PR's head commit
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"state\":\"success\",\"target_url\":\"$PREVIEW_URL\",\"description\":\"Preview deployed\",\"context\":\"firebase/preview\"}" \
              "https://api.github.com/repos/$GITHUB_REPOSITORY/statuses/$PR_HEAD_SHA"

            # Also post a comment to the PR (optional)
            echo "Posting preview URL to PR #${PR_NUMBER}"
            COMMENT_BODY="Preview URL for this PR: $PREVIEW_URL"
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" -d "{\"body\": \"$COMMENT_BODY\"}" "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${PR_NUMBER}/comments"
          else
            echo "No preview URL found in deploy output."
          fi
